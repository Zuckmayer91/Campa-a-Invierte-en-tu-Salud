<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chosen Palette: Corporate Wellness -->
    <!-- Application Structure Plan: Se diseñó un tablero de control de una sola página con navegación fija. La estructura sigue un flujo lógico para un gerente: comienza con el objetivo principal (el QUÉ), explica la estrategia (el PORQUÉ), detalla el plan de ejecución interactivo (el CÓMO), muestra los recursos creativos (LOS ACTIVOS), visualiza los resultados esperados con un gráfico y controles deslizantes (el RESULTADO) y finaliza con la solicitud de aprobación (la ACCIÓN). Esta estructura facilita la comprensión rápida y la toma de decisiones al transformar un informe estático en una experiencia interactiva y digerible. -->
    <!-- Visualization & Content Choices: 
         - Objetivo Estratégico -> Informar -> Tarjetas de métricas clave -> Interacción: Resaltado al pasar el ratón -> Justificación: Presenta los datos más importantes de inmediato.
         - Plan de Ejecución -> Organizar/Explorar -> Línea de tiempo horizontal interactiva (HTML/CSS/JS) -> Interacción: Clic para mostrar detalles -> Justificación: Transforma una lista de tareas en un flujo de campaña claro y atractivo.
         - Recursos Creativos -> Organizar/Explorar -> Pestañas con editor visual WYSIWYG para emails (contentEditable) y campos de texto para SMS/WA -> Interacción: Subir, editar, guardar (Firestore) y descargar el HTML modificado -> Justificación: Se crea un flujo de trabajo colaborativo completo donde los cambios se guardan en la nube.
         - KPIs y Proyecciones -> Comparar/Explorar/Registrar -> Gráfico de barras comparativo (Proyectado vs. Real), controles deslizantes para metas y campos de entrada para resultados reales (todo guardado en Firestore) -> Interacción: Ajustar metas e ingresar datos reales -> Justificación: Se crea un ciclo completo de planificación y seguimiento, comparando expectativas con la realidad en tiempo real.
         - Aprobación -> Decidir/Registrar -> Sistema de estado interactivo con modal para feedback y opción para revertir la decisión (guardado en Firestore) -> Interacción: Aprobar, rechazar o solicitar cambios, y luego poder cambiar la decisión -> Justificación: El proceso de aprobación es ahora colaborativo y persistente en la nube.
         - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>Tablero de Control: Campaña "Invierte en tu Salud"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        h1, h2, h3, .font-lexend {
            font-family: 'Lexend', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Wider for bar chart */
            height: auto;
            margin: auto;
        }
        .nav-link.active {
            color: #2563eb;
            font-weight: 600;
        }
        .tab-btn.active {
            background-color: #2563eb;
            color: #ffffff;
        }
        .email-nav-btn.active {
            background-color: #eef2ff;
            color: #3730a3;
            font-weight: 600;
        }
        /* Estilos para los campos de texto editables */
        .editable-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            font-family: inherit;
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .editable-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        /* Notificación de guardado */
        #save-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #16a34a;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            visibility: hidden;
        }
        #save-notification.show {
            opacity: 1;
            transform: translate(-50%, -10px);
            visibility: visible;
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="font-lexend text-xl font-bold text-slate-900">
                    Plan de Campaña Digital
                </div>
                <div class="hidden md:flex items-center space-x-8 text-sm font-medium text-slate-600">
                    <a href="#objetivo" class="nav-link hover:text-blue-600 transition-colors">Estrategia</a>
                    <a href="#ejecucion" class="nav-link hover:text-blue-600 transition-colors">Ejecución</a>
                    <a href="#recursos" class="nav-link hover:text-blue-600 transition-colors">Recursos</a>
                    <a href="#kpis" class="nav-link hover:text-blue-600 transition-colors">Resultados</a>
                    <a href="#aprobacion" class="nav-link hover:text-blue-600 transition-colors">Aprobación</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- SECCIÓN 1: OBJETIVO ESTRATÉGICO -->
        <section id="objetivo" class="mb-20 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4">Campaña "Invierte en tu Salud"</h1>
            <p class="text-lg text-slate-600 max-w-3xl mx-auto mb-10">Un plan para reactivar nuestra base de datos, enfocándonos en una propuesta de valor que resuena con las necesidades actuales: el bienestar como la mejor inversión.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h3 class="font-lexend text-slate-900 text-3xl font-bold">1,650</h3>
                    <p class="text-sm text-slate-500">Interesados en Base de Datos</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h3 class="font-lexend text-slate-900 text-3xl font-bold">Doble Inversión</h3>
                    <p class="text-sm text-slate-500">Nuestro Mensaje Central</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h3 class="font-lexend text-slate-900 text-3xl font-bold">3 Días</h3>
                    <p class="text-sm text-slate-500">Duración de la Campaña</p>
                </div>
            </div>
        </section>

        <!-- SECCIÓN 2: PLAN DE EJECUCIÓN -->
        <section id="ejecucion" class="mb-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-900 mb-3">Plan de Ejecución Multicanal</h2>
                <p class="text-slate-600 max-w-2xl mx-auto">Una campaña secuencial de 3 días para guiar al usuario desde la conciencia hasta la decisión. Haga clic en cada fase para ver los detalles.</p>
            </div>
            <div class="flex flex-col md:flex-row bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="md:w-1/2 p-8">
                    <div id="timeline-details" class="transition-opacity duration-500">
                        <div class="border-l-4 border-blue-500 pl-4">
                            <h3 id="detail-title" class="font-lexend text-2xl font-bold text-slate-900">Fase 1: Impacto y Conciencia</h3>
                            <p id="detail-day" class="text-sm font-medium text-blue-600 mb-3">Día 1</p>
                        </div>
                        <p class="font-semibold text-slate-800 mt-4 mb-2">Objetivo:</p>
                        <p id="detail-objective" class="text-slate-600 mb-4">Captar la atención con el nuevo ángulo emocional y presentar el "porqué" de la inversión en bienestar.</p>
                        <p class="font-semibold text-slate-800 mb-2">Acciones:</p>
                        <ul id="detail-actions" class="text-slate-600 list-disc list-inside space-y-1">
                            <li>Envío masivo de <strong>Email #1 (Enfoque Salud)</strong></li>
                            <li>Envío masivo de <strong>SMS #1</strong></li>
                        </ul>
                    </div>
                </div>
                <div class="md:w-1/2 p-8 bg-slate-50 border-t md:border-t-0 md:border-l border-slate-200 flex items-center">
                    <div class="w-full">
                        <div class="relative">
                            <div class="absolute left-0 top-1/2 w-full h-1 bg-slate-300 rounded-full" aria-hidden="true"></div>
                            <div class="relative flex justify-between items-center">
                                <button data-day="1" class="timeline-dot z-10 flex flex-col items-center group cursor-pointer">
                                    <div class="w-6 h-6 bg-white border-4 border-blue-500 rounded-full transition-all"></div>
                                    <span class="mt-2 text-sm font-semibold text-blue-600">Día 1</span>
                                </button>
                                <button data-day="2" class="timeline-dot z-10 flex flex-col items-center group cursor-pointer">
                                    <div class="w-4 h-4 bg-white border-2 border-slate-400 rounded-full transition-all group-hover:border-blue-500 group-hover:scale-125"></div>
                                    <span class="mt-3 text-sm font-medium text-slate-500 group-hover:text-blue-600">Día 2</span>
                                </button>
                                <button data-day="3" class="timeline-dot z-10 flex flex-col items-center group cursor-pointer">
                                    <div class="w-4 h-4 bg-white border-2 border-slate-400 rounded-full transition-all group-hover:border-blue-500 group-hover:scale-125"></div>
                                    <span class="mt-3 text-sm font-medium text-slate-500 group-hover:text-blue-600">Día 3</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN 3: RECURSOS DE LA CAMPAÑA (EDITABLE) -->
        <section id="recursos" class="mb-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-900 mb-3">Recursos de la Campaña (Editable)</h2>
                <p class="text-slate-600 max-w-2xl mx-auto">Previsualice y edite los activos creativos que se enviarán en cada canal. Los cambios se guardarán en la nube.</p>
            </div>
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4 sm:p-6">
                <!-- Tabs -->
                <div class="mb-6 border-b border-slate-200">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button data-tab="emails" class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-blue-600 rounded-t-lg">
                            ✉️ Emails
                        </button>
                        <button data-tab="sms" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-blue-600 rounded-t-lg">
                            📱 SMS
                        </button>
                        <button data-tab="whatsapp" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-blue-600 rounded-t-lg">
                            💬 WhatsApp
                        </button>
                    </nav>
                </div>
                <!-- Tab Content -->
                <div id="tab-content">
                    <div id="emails-content" class="tab-pane">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="lg:w-1/4">
                                <nav class="flex flex-col space-y-1">
                                    <button data-email="1" class="email-nav-btn active text-left p-3 rounded-lg hover:bg-slate-100 transition-colors">
                                        <span class="font-bold block">Email 1: Enfoque Salud</span>
                                        <span class="text-xs text-slate-500">Día 1 - Conciencia</span>
                                    </button>
                                    <button data-email="2" class="email-nav-btn text-left p-3 rounded-lg hover:bg-slate-100 transition-colors">
                                        <span class="font-bold block">Email 2: Foco en Web</span>
                                        <span class="text-xs text-slate-500">Día 2 - Consideración</span>
                                    </button>
                                    <button data-email="3" class="email-nav-btn text-left p-3 rounded-lg hover:bg-slate-100 transition-colors">
                                        <span class="font-bold block">Email 3: Contacto WA</span>
                                        <span class="text-xs text-slate-500">Día 3 - Decisión</span>
                                    </button>
                                </nav>
                            </div>
                            <div class="lg:w-3/4 flex flex-col gap-4">
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-2">Editor Visual (Haga clic en el correo de abajo para editar)</h4>
                                    <div class="bg-slate-100 rounded-lg p-2 transition-all focus-within:ring-2 focus-within:ring-blue-500">
                                        <iframe id="email-preview" class="w-full h-[600px] rounded-md border-2 border-slate-200"></iframe>
                                    </div>
                                </div>
                                <div class="text-right flex flex-wrap justify-end gap-3">
                                    <button id="save-email-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Guardar Cambios</button>
                                    <button id="upload-email-btn" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">Subir HTML</button>
                                    <button id="download-email-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Descargar HTML</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="sms-content" class="tab-pane hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <h4 class="font-bold text-slate-800 mb-2">SMS 1: Directo</h4>
                                <textarea id="sms-1-editor" class="editable-textarea">Hola *|NOMBRE|*, invierte en tu activo más valioso: tu salud. Lotes campestres para una vida sin estrés. Conoce más aquí: https://www.aypch.com/</textarea>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <h4 class="font-bold text-slate-800 mb-2">SMS 2: Problema</h4>
                                <textarea id="sms-2-editor" class="editable-textarea">¿Cansado del ruido y el afán? Tu bienestar es primero. Descubre tu refugio de paz en el Valle del Cauca. Info: https://www.aypch.com/</textarea>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <h4 class="font-bold text-slate-800 mb-2">SMS 3: Beneficio</h4>
                                <textarea id="sms-3-editor" class="editable-textarea">Respira aire puro, vive tranquilo. Elige un futuro más saludable para ti y tu familia. Explora nuestros proyectos: https://www.aypch.com/</textarea>
                            </div>
                        </div>
                        <div class="text-right mt-6">
                            <button id="save-sms-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Guardar Cambios de SMS</button>
                        </div>
                    </div>
                    <div id="whatsapp-content" class="tab-pane hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                             <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h4 class="font-bold text-green-800 mb-2">Plantilla 1: Inspiradora</h4>
                                <textarea id="wa-1-editor" class="editable-textarea bg-white">¡Hola *|NOMBRE|*! 👋\n\n¿Has pensado cuánto vale tu tranquilidad? Te invitamos a descubrir nuestros proyectos campestres, diseñados para que tú y tu familia respiren aire puro.\n\n✨ Dale un vistazo aquí: https://www.aypch.com/</textarea>
                            </div>
                             <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h4 class="font-bold text-green-800 mb-2">Plantilla 2: Beneficios</h4>
                                <textarea id="wa-2-editor" class="editable-textarea bg-white">¡Hola *|NOMBRE|*! 🌿 Tu salud te lo agradecerá.\n\nImagina un lugar donde puedas:\n✅ Despertar con la naturaleza.\n✅ Disfrutar de aire 100% puro.\n✅ Tener espacio para caminar y jugar.\n\n👉 Ver Proyectos: https://www.aypch.com/</textarea>
                            </div>
                             <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h4 class="font-bold text-green-800 mb-2">Plantilla 3: Conversacional</h4>
                                <textarea id="wa-3-editor" class="editable-textarea bg-white">¡Hola *|NOMBRE|*! Te saluda [Tu Nombre] de AYPCH.\n\nVi que te interesa mejorar tu calidad de vida. ¿Te gustaría recibir información exclusiva sobre nuestros proyectos sin ningún compromiso?\n\nPuedes ver todos los detalles en nuestro sitio web: https://www.aypch.com/</textarea>
                            </div>
                        </div>
                        <div class="text-right mt-6">
                            <button id="save-wa-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Guardar Cambios de WhatsApp</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN 4: RESULTADOS DE LA CAMPAÑA -->
        <section id="kpis" class="mb-20">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-900 mb-3">Resultados de la Campaña</h2>
                <p class="text-slate-600 max-w-2xl mx-auto">Defina sus metas, registre los resultados reales y compare el rendimiento de la campaña en tiempo real.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Columna de Datos (Metas y Reales) -->
                <div class="flex flex-col gap-8">
                    <!-- Metas y Proyecciones Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-lexend text-xl font-bold text-slate-900 mb-6">Metas y Proyecciones</h3>
                        <div class="space-y-5">
                            <div>
                                <label for="open-rate-slider" class="block text-sm font-medium text-slate-700 mb-1">Tasa de Apertura de Correo (<span id="open-rate-value">25</span>%)</label>
                                <input id="open-rate-slider" type="range" min="1" max="50" value="25" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="ctr-slider" class="block text-sm font-medium text-slate-700 mb-1">Tasa de Clics (CTR) (<span id="ctr-value">10</span>%)</label>
                                <input id="ctr-slider" type="range" min="1" max="20" value="10" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="lead-conversion-slider" class="block text-sm font-medium text-slate-700 mb-1">Conversión a Cita (<span id="lead-conversion-value">30</span>%)</label>
                                <input id="lead-conversion-slider" type="range" min="1" max="60" value="30" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                         <div class="mt-6 pt-5 border-t border-slate-200 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm text-slate-500">Aperturas Proy.</p>
                                <p id="projected-opens" class="font-lexend text-2xl font-bold text-slate-900">413</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Clics Proy.</p>
                                <p id="projected-leads" class="font-lexend text-2xl font-bold text-blue-600">41</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Citas Proy.</p>
                                <p id="projected-appointments" class="font-lexend text-2xl font-bold text-green-600">12</p>
                            </div>
                        </div>
                    </div>
                    <!-- Resultados Reales Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-lexend text-xl font-bold text-slate-900 mb-6">Resultados Reales de la Campaña</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="real-opens-input" class="block text-sm font-medium text-slate-700">Correos con Apertura (Real)</label>
                                <input type="number" id="real-opens-input" min="0" placeholder="Ej: 350" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="real-clicks-input" class="block text-sm font-medium text-slate-700">Leads / Clics (Real)</label>
                                <input type="number" id="real-clicks-input" min="0" placeholder="Ej: 35" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="real-appointments-input" class="block text-sm font-medium text-slate-700">Citas Agendadas (Real)</label>
                                <input type="number" id="real-appointments-input" min="0" placeholder="Ej: 10" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                            <button id="save-real-results-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Guardar Resultados</button>
                        </div>
                    </div>
                </div>
                <!-- Columna del Gráfico -->
                <div class="flex flex-col items-center sticky top-28">
                    <div class="chart-container w-full h-full bg-white p-4 rounded-xl shadow-lg border border-slate-200">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN 5: APROBACIÓN -->
        <section id="aprobacion" class="bg-white rounded-xl shadow-lg border border-slate-200 p-8 md:p-12">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-slate-900 mb-3">Solicitud de Aprobación</h2>
                <div id="approval-status-container" class="hidden">
                    <!-- El estado de la aprobación se mostrará aquí -->
                </div>
                <div id="approval-pending-container">
                    <p class="text-slate-600 max-w-2xl mx-auto mb-8">Esta campaña está diseñada para maximizar el ROI de nuestra base de datos existente, utilizando una estrategia relevante y un plan de ejecución medible. Por favor, revise y tome una acción.</p>
                    <div class="flex justify-center items-center space-x-8 mb-8">
                        <div class="text-center">
                            <p class="text-sm text-slate-500 mb-1">Herramientas</p>
                            <div class="flex flex-wrap justify-center gap-2">
                               <span class="bg-slate-200 text-slate-700 text-xs font-bold px-3 py-1 rounded-full">RD Station</span>
                               <span class="bg-slate-200 text-slate-700 text-xs font-bold px-3 py-1 rounded-full">SMS Masivo</span>
                               <span class="bg-slate-200 text-slate-700 text-xs font-bold px-3 py-1 rounded-full">WhatsApp</span>
                            </div>
                        </div>
                    </div>
                    <div id="approval-buttons" class="flex flex-wrap justify-center gap-4">
                        <button id="approve-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-700 transition-transform hover:scale-105">
                            ✓ Aprobar Campaña
                        </button>
                        <button id="request-changes-btn" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-yellow-600 transition-transform hover:scale-105">
                            ✎ Solicitar Cambios
                        </button>
                        <button id="reject-btn" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-red-700 transition-transform hover:scale-105">
                            ✗ Rechazar
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <footer class="text-center py-8">
        <p class="text-sm text-slate-500">&copy; 2025 Asesorías y Parcelaciones CH. Presentación Interna.</p>
    </footer>

    <!-- Elemento para la notificación de guardado -->
    <div id="save-notification">¡Guardado!</div>
    
    <!-- Input de archivo oculto para la subida de HTML -->
    <input type="file" id="file-input" class="hidden" accept=".html">

    <!-- Modal para Feedback de Aprobación -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="feedback-modal-title" class="text-2xl font-bold text-slate-900 mb-4"></h3>
            <textarea id="feedback-comments" class="editable-textarea w-full" rows="5" placeholder="Por favor, especifique los cambios requeridos o la razón del rechazo..."></textarea>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancel-feedback-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="submit-feedback-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Enviar Feedback</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-modal-title" class="text-lg font-bold text-slate-900 mb-4">Confirmar Acción</h3>
            <p id="confirm-modal-text" class="text-slate-600 mb-6">¿Está seguro?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="confirm-modal-ok-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyCafKhBYlNFTZgTVPDNlv-y_aCgjVcOpyI",
                authDomain: "salud-22f6d.firebaseapp.com",
                projectId: "salud-22f6d",
                storageBucket: "salud-22f6d.appspot.com",
                messagingSenderId: "496474390081",
                appId: "1:496474390081:web:bf42fe36e0c930a9b590c0",
                measurementId: "G-8L3BSJN4MC"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'campaign-dashboard-app';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let campaignDocRef;

        document.addEventListener('DOMContentLoaded', () => {
            const totalDatabase = 1650;

            // --- LÓGICA DE NOTIFICACIONES Y MODALES ---
            const notification = document.getElementById('save-notification');
            function showSaveNotification(message = '¡Guardado!', isError = false) {
                notification.textContent = message;
                notification.style.backgroundColor = isError ? '#dc2626' : '#16a34a';
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');
            let confirmCallback = null;

            function showConfirm(title, text, onConfirm) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            }

            confirmModalCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                confirmCallback = null;
            });

            confirmModalOkBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                confirmCallback = null;
            });
            
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.classList.add('hidden');
                    confirmModal.classList.remove('flex');
                }
            });

            // --- LÓGICA DEL TIMELINE ---
            const timelineDots = document.querySelectorAll('.timeline-dot');
            const detailTitle = document.getElementById('detail-title');
            const detailDay = document.getElementById('detail-day');
            const detailObjective = document.getElementById('detail-objective');
            const detailActions = document.getElementById('detail-actions');
            const timelineDetailsContainer = document.getElementById('timeline-details');
            const timelineData = {
                '1': { title: 'Fase 1: Impacto y Conciencia', day: 'Día 1', objective: 'Captar la atención con el nuevo ángulo emocional y presentar el "porqué" de la inversión en bienestar.', actions: ['Envío masivo de <strong>Email #1 (Enfoque Salud)</strong>', 'Envío masivo de <strong>SMS #1</strong>'] },
                '2': { title: 'Fase 2: Consideración y Tráfico', day: 'Día 2', objective: 'Dirigir el interés generado hacia nuestro sitio web para que exploren los proyectos y la propuesta de valor completa.', actions: ['Envío de <strong>Email #2 (Redirección a Web)</strong>', 'Envío de <strong>SMS #2</strong>'] },
                '3': { title: 'Fase 3: Urgencia y Decisión', day: 'Día 3', objective: 'Crear un sentido de oportunidad y motivar a los interesados a no dejar pasar la decisión de invertir en su futuro.', actions: ['Envío de <strong>Email #3 (Resumen/Última Llamada)</strong>', 'Envío de <strong>SMS #3</strong>'] }
            };
            timelineDots.forEach(dot => {
                dot.addEventListener('click', () => {
                    const day = dot.dataset.day;
                    const data = timelineData[day];
                    timelineDetailsContainer.style.opacity = 0;
                    setTimeout(() => {
                        detailTitle.textContent = data.title;
                        detailDay.textContent = data.day;
                        detailObjective.textContent = data.objective;
                        detailActions.innerHTML = data.actions.map(action => `<li>${action}</li>`).join('');
                        timelineDetailsContainer.style.opacity = 1;
                    }, 300);
                    timelineDots.forEach(d => {
                        d.querySelector('div').classList.remove('w-6', 'h-6', 'border-4', 'border-blue-500');
                        d.querySelector('div').classList.add('w-4', 'h-4', 'border-2', 'border-slate-400');
                        d.querySelector('span').classList.remove('text-blue-600', 'font-semibold');
                        d.querySelector('span').classList.add('text-slate-500', 'font-medium');
                    });
                    dot.querySelector('div').classList.add('w-6', 'h-6', 'border-4', 'border-blue-500');
                    dot.querySelector('div').classList.remove('w-4', 'h-4', 'border-2', 'border-slate-400');
                    dot.querySelector('span').classList.add('text-blue-600', 'font-semibold');
                    dot.querySelector('span').classList.remove('text-slate-500', 'font-medium');
                });
            });

            // --- LÓGICA DE RECURSOS ---
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    tabPanes.forEach(pane => {
                        pane.classList.toggle('hidden', pane.id !== `${tab}-content`);
                    });
                });
            });

            const emailNavBtns = document.querySelectorAll('.email-nav-btn');
            const emailPreview = document.getElementById('email-preview');
            const saveEmailBtn = document.getElementById('save-email-btn');
            const downloadEmailBtn = document.getElementById('download-email-btn');
            const uploadEmailBtn = document.getElementById('upload-email-btn');
            const fileInput = document.getElementById('file-input');
            let currentEmailId = '1';

            const emailTemplates = {
                '1': 'https://storage.googleapis.com/gemini-generative-ai-docs/1correo-salud-web.html',
                '2': 'https://storage.googleapis.com/gemini-generative-ai-docs/2correo-salud-web.html',
                '3': 'https://storage.googleapis.com/gemini-generative-ai-docs/3correo-salud-whatsapp.html'
            };

            async function updateEmailPreview(emailId, firestoreData) {
                currentEmailId = emailId;
                const fieldName = `email_${emailId}_content`;
                const savedContent = firestoreData && firestoreData.emails ? firestoreData.emails[fieldName] : null;

                let content = '';
                if (savedContent) {
                    content = savedContent;
                } else {
                    try {
                        const response = await fetch(emailTemplates[emailId]);
                        if (response.ok) {
                           content = await response.text();
                        } else {
                           content = '<body><p>Error al cargar la plantilla. Verifique que el archivo exista.</p></body>';
                        }
                    } catch (error) {
                        console.error("Error fetching email template:", error);
                        content = '<body><p>No se pudo conectar para cargar la plantilla.</p></body>';
                    }
                }
                
                emailPreview.srcdoc = content;

                emailPreview.onload = () => {
                    try {
                        emailPreview.contentDocument.body.contentEditable = true;
                        emailPreview.contentDocument.body.style.fontFamily = "'Inter', sans-serif";
                        emailPreview.contentDocument.body.style.color = '#334155';
                        emailPreview.contentDocument.body.style.outline = 'none';
                        emailPreview.contentDocument.body.style.padding = '1rem';
                    } catch (e) {
                        console.error("Could not make iframe editable:", e);
                    }
                };

                emailNavBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.email === emailId);
                });
            }

            async function saveEmailContentToFirestore() {
                if (!campaignDocRef) return;
                const fieldName = `emails.email_${currentEmailId}_content`;
                const newContent = emailPreview.contentDocument.documentElement.outerHTML;
                try {
                    await setDoc(campaignDocRef, { emails: { [fieldName.split('.')[1]]: newContent } }, { merge: true });
                    showSaveNotification('¡Cambios guardados en la nube!');
                } catch (error) {
                    console.error("Error saving email to Firestore: ", error);
                    showSaveNotification("Error al guardar los cambios.", true);
                }
            }

            saveEmailBtn.addEventListener('click', saveEmailContentToFirestore);
            
            downloadEmailBtn.addEventListener('click', () => {
                const content = emailPreview.contentDocument.documentElement.outerHTML;
                const blob = new Blob([content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `email_modificado_${currentEmailId}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            uploadEmailBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type === 'text/html') {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const content = e.target.result;
                        emailPreview.srcdoc = content;
                        const fieldName = `emails.email_${currentEmailId}_content`;
                        try {
                            await setDoc(campaignDocRef, { emails: { [fieldName.split('.')[1]]: content } }, { merge: true });
                            showSaveNotification('¡Plantilla cargada y guardada!');
                        } catch (error) {
                            console.error("Error uploading email to Firestore: ", error);
                            showSaveNotification("Error al subir la plantilla.", true);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showSaveNotification('Por favor, seleccione un archivo HTML válido.', true);
                }
                event.target.value = '';
            });

            emailNavBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                     updateEmailPreview(btn.dataset.email, {});
                });
            });
            
            const smsEditors = [document.getElementById('sms-1-editor'), document.getElementById('sms-2-editor'), document.getElementById('sms-3-editor')];
            const saveSmsBtn = document.getElementById('save-sms-btn');

            async function saveSmsToFirestore() {
                if (!campaignDocRef) return;
                const smsData = {
                    sms_1_content: smsEditors[0].value,
                    sms_2_content: smsEditors[1].value,
                    sms_3_content: smsEditors[2].value,
                };
                try {
                    await setDoc(campaignDocRef, { sms: smsData }, { merge: true });
                    showSaveNotification('¡Cambios de SMS guardados!');
                } catch (error) {
                    console.error("Error saving SMS to Firestore: ", error);
                    showSaveNotification("Error al guardar los cambios de SMS.", true);
                }
            }
            saveSmsBtn.addEventListener('click', saveSmsToFirestore);

            const waEditors = [document.getElementById('wa-1-editor'), document.getElementById('wa-2-editor'), document.getElementById('wa-3-editor')];
            const saveWaBtn = document.getElementById('save-wa-btn');
            
            async function saveWaToFirestore() {
                if (!campaignDocRef) return;
                const waData = {
                    wa_1_content: waEditors[0].value,
                    wa_2_content: waEditors[1].value,
                    wa_3_content: waEditors[2].value,
                };
                try {
                    await setDoc(campaignDocRef, { whatsapp: waData }, { merge: true });
                    showSaveNotification('¡Cambios de WhatsApp guardados!');
                } catch (error) {
                    console.error("Error saving WhatsApp to Firestore: ", error);
                    showSaveNotification("Error al guardar los cambios de WhatsApp.", true);
                }
            }
            saveWaBtn.addEventListener('click', saveWaToFirestore);

            // --- LÓGICA DE KPIS Y GRÁFICO ---
            // Elementos de Proyecciones
            const openRateSlider = document.getElementById('open-rate-slider');
            const ctrSlider = document.getElementById('ctr-slider');
            const leadConversionSlider = document.getElementById('lead-conversion-slider');
            const openRateValue = document.getElementById('open-rate-value');
            const ctrValue = document.getElementById('ctr-value');
            const leadConversionValue = document.getElementById('lead-conversion-value');
            const projectedOpens = document.getElementById('projected-opens');
            const projectedLeads = document.getElementById('projected-leads');
            const projectedAppointments = document.getElementById('projected-appointments');

            // Elementos de Resultados Reales
            const realOpensInput = document.getElementById('real-opens-input');
            const realClicksInput = document.getElementById('real-clicks-input');
            const realAppointmentsInput = document.getElementById('real-appointments-input');
            const saveRealResultsBtn = document.getElementById('save-real-results-btn');

            // Gráfico
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Aperturas', 'Clics', 'Citas'],
                    datasets: [
                        {
                            label: 'Proyectado',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Real',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(34, 197, 94, 0.5)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#475569' // slate-600
                            }
                        },
                        x: {
                             ticks: {
                                color: '#475569' // slate-600
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#475569' // slate-600
                            }
                        },
                        title: {
                            display: true,
                            text: 'Rendimiento de la Campaña',
                            color: '#1e293b' // slate-800
                        }
                    }
                }
            });

            function updateChart() {
                // Datos Proyectados (de los sliders)
                const openRate = parseInt(openRateSlider.value) / 100;
                const ctr = parseInt(ctrSlider.value) / 100;
                const leadConversion = parseInt(leadConversionSlider.value) / 100;
                const projectedOpensNum = Math.round(totalDatabase * openRate);
                const projectedLeadsNum = Math.round(projectedOpensNum * ctr);
                const projectedAppointmentsNum = Math.round(projectedLeadsNum * leadConversion);

                // Datos Reales (de los inputs)
                const realOpensNum = Number(realOpensInput.value) || 0;
                const realClicksNum = Number(realClicksInput.value) || 0;
                const realAppointmentsNum = Number(realAppointmentsInput.value) || 0;

                // Actualizar datasets del gráfico
                comparisonChart.data.datasets[0].data = [projectedOpensNum, projectedLeadsNum, projectedAppointmentsNum];
                comparisonChart.data.datasets[1].data = [realOpensNum, realClicksNum, realAppointmentsNum];
                
                comparisonChart.update();
            }

            function updateProjectionUI() {
                const openRate = parseInt(openRateSlider.value) / 100;
                const ctr = parseInt(ctrSlider.value) / 100;
                const leadConversion = parseInt(leadConversionSlider.value) / 100;
                openRateValue.textContent = openRateSlider.value;
                ctrValue.textContent = ctrSlider.value;
                leadConversionValue.textContent = leadConversionSlider.value;
                const opens = Math.round(totalDatabase * openRate);
                const leads = Math.round(opens * ctr);
                const appointments = Math.round(leads * leadConversion);
                projectedOpens.textContent = opens.toLocaleString();
                projectedLeads.textContent = leads.toLocaleString();
                projectedAppointments.textContent = appointments.toLocaleString();
                
                updateChart();
            }

            async function saveProjectionsToFirestore() {
                if (!campaignDocRef) return;
                try {
                    await setDoc(campaignDocRef, {
                        kpis: {
                            projections: {
                                open_rate: openRateSlider.value,
                                ctr: ctrSlider.value,
                                lead_conversion: leadConversionSlider.value
                            }
                        }
                    }, { merge: true });
                } catch (error) {
                    console.error("Error saving projections to Firestore: ", error);
                    showSaveNotification("Error al guardar proyecciones.", true);
                }
            }

            async function saveRealResultsToFirestore() {
                if (!campaignDocRef) return;
                const realData = {
                    opens: Number(realOpensInput.value) || 0,
                    clicks: Number(realClicksInput.value) || 0,
                    appointments: Number(realAppointmentsInput.value) || 0,
                };
                try {
                    await setDoc(campaignDocRef, { kpis: { real_results: realData } }, { merge: true });
                    showSaveNotification('¡Resultados reales guardados!');
                } catch (error) {
                    console.error("Error saving real results to Firestore: ", error);
                    showSaveNotification("Error al guardar los resultados.", true);
                }
            }
            
            // Event Listeners para Proyecciones
            openRateSlider.addEventListener('input', updateProjectionUI);
            ctrSlider.addEventListener('input', updateProjectionUI);
            leadConversionSlider.addEventListener('input', updateProjectionUI);
            openRateSlider.addEventListener('change', saveProjectionsToFirestore);
            ctrSlider.addEventListener('change', saveProjectionsToFirestore);
            leadConversionSlider.addEventListener('change', saveProjectionsToFirestore);

            // Event Listeners para Resultados Reales
            saveRealResultsBtn.addEventListener('click', saveRealResultsToFirestore);
            realOpensInput.addEventListener('input', updateChart);
            realClicksInput.addEventListener('input', updateChart);
            realAppointmentsInput.addEventListener('input', updateChart);
            
            // --- LÓGICA DE APROBACIÓN ---
            const approvalStatusContainer = document.getElementById('approval-status-container');
            const approvalPendingContainer = document.getElementById('approval-pending-container');
            const approveBtn = document.getElementById('approve-btn');
            const requestChangesBtn = document.getElementById('request-changes-btn');
            const rejectBtn = document.getElementById('reject-btn');
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackModalTitle = document.getElementById('feedback-modal-title');
            const feedbackComments = document.getElementById('feedback-comments');
            const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
            const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
            let currentDecision = '';

            function setApprovalState(approvalData) {
                if (!approvalData || !approvalData.status) {
                    approvalStatusContainer.classList.add('hidden');
                    approvalPendingContainer.classList.remove('hidden');
                    return;
                }

                const { status, date, comments } = approvalData;
                approvalPendingContainer.classList.add('hidden');
                approvalStatusContainer.classList.remove('hidden');

                let statusHTML = '';
                const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                const formattedDate = new Date(date).toLocaleDateString('es-ES', options);
                const resetBtnHTML = `<button id="reset-approval-btn" class="bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg border border-slate-300 hover:bg-slate-100 text-sm">Cambiar Decisión</button>`;

                switch(status) {
                    case 'Aprobado':
                        statusHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-r-lg" role="alert"><div class="flex justify-between items-center"><div><p class="font-bold text-lg">Campaña Aprobada</p><p class="text-sm">Decisión tomada el: ${formattedDate}</p></div>${resetBtnHTML}</div></div>`;
                        break;
                    case 'Cambios Solicitados':
                         statusHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-r-lg" role="alert"><div class="flex justify-between items-start"><div><p class="font-bold text-lg">Se Solicitaron Cambios</p><p class="text-sm">Decisión tomada el: ${formattedDate}</p><p class="mt-2 text-sm italic"><strong>Comentarios:</strong> "${comments}"</p></div>${resetBtnHTML}</div></div>`;
                        break;
                    case 'Rechazado':
                        statusHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg" role="alert"><div class="flex justify-between items-start"><div><p class="font-bold text-lg">Campaña Rechazada</p><p class="text-sm">Decisión tomada el: ${formattedDate}</p><p class="mt-2 text-sm italic"><strong>Justificación:</strong> "${comments}"</p></div>${resetBtnHTML}</div></div>`;
                        break;
                }
                approvalStatusContainer.innerHTML = statusHTML;
                
                document.getElementById('reset-approval-btn').addEventListener('click', () => {
                    showConfirm('Cambiar Decisión', '¿Está seguro de que desea cambiar su decisión? El estado actual se borrará.', async () => {
                        try {
                            await setDoc(campaignDocRef, { approval: {} }, { merge: true });
                        } catch (error) {
                            console.error("Error resetting approval: ", error);
                            showSaveNotification("Error al cambiar la decisión.", true);
                        }
                    });
                });
            }

            async function saveApprovalStatus(status, comments) {
                const approvalData = {
                    status: status,
                    comments: comments,
                    date: new Date().toISOString()
                };
                try {
                    await setDoc(campaignDocRef, { approval: approvalData }, { merge: true });
                } catch (error) {
                    console.error("Error saving approval status: ", error);
                    showSaveNotification("Error al guardar la aprobación.", true);
                }
            }

            approveBtn.addEventListener('click', () => {
                showConfirm('Aprobar Campaña', '¿Está seguro de que desea aprobar esta campaña?', () => {
                    saveApprovalStatus('Aprobado', '');
                });
            });

            requestChangesBtn.addEventListener('click', () => {
                currentDecision = 'Cambios Solicitados';
                feedbackModalTitle.textContent = 'Solicitar Cambios';
                feedbackComments.value = '';
                feedbackComments.placeholder = 'Especifique los cambios requeridos...';
                feedbackModal.classList.remove('hidden');
                feedbackModal.classList.add('flex');
            });

            rejectBtn.addEventListener('click', () => {
                currentDecision = 'Rechazado';
                feedbackModalTitle.textContent = 'Rechazar Campaña';
                feedbackComments.value = '';
                feedbackComments.placeholder = 'Justifique la razón del rechazo...';
                feedbackModal.classList.remove('hidden');
                feedbackModal.classList.add('flex');
            });

            cancelFeedbackBtn.addEventListener('click', () => {
                feedbackModal.classList.add('hidden');
                feedbackModal.classList.remove('flex');
            });
            
            feedbackModal.addEventListener('click', (e) => {
                if (e.target === feedbackModal) {
                    feedbackModal.classList.add('hidden');
                    feedbackModal.classList.remove('flex');
                }
            });

            submitFeedbackBtn.addEventListener('click', () => {
                const comments = feedbackComments.value.trim();
                if (comments) {
                    saveApprovalStatus(currentDecision, comments);
                    feedbackModal.classList.add('hidden');
                    feedbackModal.classList.remove('flex');
                } else {
                    showSaveNotification('Por favor, ingrese sus comentarios.', true);
                }
            });

            // --- LÓGICA DE NAVEGACIÓN ACTIVA ---
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('.nav-link');
            window.addEventListener('scroll', () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if(link.getAttribute('href') === `#${current}`){
                        link.classList.add('active');
                    }
                });
            });

            // --- FUNCIÓN PRINCIPAL DE CARGA DE DATOS DESDE FIRESTORE ---
            function loadAllDataFromFirestore(doc) {
                const data = doc.exists() ? doc.data() : {};

                // Cargar Emails, SMS, WhatsApp
                updateEmailPreview(currentEmailId, data);
                if (data.sms) {
                    smsEditors[0].value = data.sms.sms_1_content || '';
                    smsEditors[1].value = data.sms.sms_2_content || '';
                    smsEditors[2].value = data.sms.sms_3_content || '';
                }
                if (data.whatsapp) {
                    waEditors[0].value = data.whatsapp.wa_1_content || '';
                    waEditors[1].value = data.whatsapp.wa_2_content || '';
                    waEditors[2].value = data.whatsapp.wa_3_content || '';
                }

                // Cargar KPIs
                if (data.kpis) {
                    if (data.kpis.projections) {
                        openRateSlider.value = data.kpis.projections.open_rate || 25;
                        ctrSlider.value = data.kpis.projections.ctr || 10;
                        leadConversionSlider.value = data.kpis.projections.lead_conversion || 30;
                    }
                    if (data.kpis.real_results) {
                        realOpensInput.value = data.kpis.real_results.opens || '';
                        realClicksInput.value = data.kpis.real_results.clicks || '';
                        realAppointmentsInput.value = data.kpis.real_results.appointments || '';
                    }
                }
                
                updateProjectionUI(); // Esto actualiza los textos de proyección y llama a updateChart()

                // Cargar Estado de Aprobación
                setApprovalState(data.approval);
            }

            // --- INICIALIZACIÓN DE AUTENTICACIÓN Y DATOS ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    campaignDocRef = doc(db, "artifacts", appId, "public/data/campaigns", "main_campaign");
                    onSnapshot(campaignDocRef, (doc) => {
                        loadAllDataFromFirestore(doc);
                    });
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error de autenticación:", error);
                        showSaveNotification("No se pudo conectar con el servicio. Por favor, recargue la página.", true);
                    }
                }
            });
        });
    </script>
</body>
</html>
